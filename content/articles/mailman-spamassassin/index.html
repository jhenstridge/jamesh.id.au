<?xml version="1.0"?> <?emacs -*- mode: nxml -*- ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Integrating SpamAssassin with Mailman</title>
  </head>
  <body>
    <h1>Integrating SpamAssassin with Mailman</h1>

    <p>If you run a moderately popular mailing list, you will have to
    address the spam problem at some point.  Many spammers actively
    target mailing lists, because if the spam doesn't get caught it
    will be forwarded to many recipients.  The first step is usually
    to hold non-subscriber posts for moderation.  This is good for the
    list users, but adds a significant burden to the list
    administrators.  It also makes it difficult to approve legitimate
    non-subscriber posts.</p>

    <p>To handle this problem, I wrote some patches to integrate the
    <a href="http://www.spamassassin.org/">SpamAssassin</a> spam
    filtering software with <a
    href="http://www.list.org/">Mailman</a>.  With this patch, the
    majority of the spam sent to the list can be discarded without
    intervention by the moderator.</p>

    <p>For some lists, the filter may reduce spam enough that
    non-subscriber posting can be turned back on.  For closed lists,
    it will be easier to moderate, as there will be a higher signal to
    noise ratio on the moderation screen, making it less likely that a
    legitimate post will be discarded.</p>

    <p>With the release of SpamAssassin 2.50, you can even customise
    the filters on a per-mailing list basis through the use of
    Bayesian analysis of messages.</p>


    <h2>Installation</h2>

    <h3>Installing Mailman</h3>

    <p>It is assumed that you already have a copy of Mailman installed
    on your system.  The current version of my patches are designed to
    work with Mailman &gt;= 2.1, so you should upgrade to 2.1.x if you
    haven't already.</p>

    <p>If you are using 2.1, you may want to upgrade to 2.1.1, as it
    fixes a number of cross site scripting vulnerabilities.  New
    releases are available from the <a
    href="http://www.list.org/">Mailman website</a> or on
    Sourceforge:</p>

    <ul>
      <li><a href="http://sourceforge.net/project/showfiles.php?group_id=103">http://sourceforge.net/project/showfiles.php?group_id=103</a></li>
    </ul>

    <p>Consult the documentation included in the source tarball for
    instructions on building and installing Mailman.</p>


    <h3>Installing SpamAssassin</h3>

    <p>SpamAssassin is available from the <a
    href="http://www.spamassassin.org/">SpamAssassin website</a>.
    Follow the installation instructions included in the tarball, or
    just install the RPMs (or rebuild the SRPM first).</p>

    <p>You should install SpamAssassin &gt;= 2.50, but more recent
    versions are preferable.</p>


    <h3>Configuring spamd</h3>

    <p>The Mailman patches make use of the <tt>spamd</tt> daemon
    included in SpamAssassin, so it will be necessary to configure it
    to run at startup.</p>

    <p>First create a new user account to run spamd as.  The home
    directory for the user should be set to something like
    <tt>/var/lib/spamassassin</tt>.  On most Linux
    distros, this can be done with the following command:</p>

    <pre class="programlisting">
mkdir /var/lib/spamassassin
useradd -r -d /var/lib/spamassassin -M -s /sbin/nologin \
    -c 'SpamAssassin' spamassassin
chown spamassassin.spamassassin /var/lib/spamassassin
</pre>

    <p>The exact details will depend on your OS.  We need to pass a
    number of arguments to spamd to get it to run in a locked down
    mode.  The arguments I use are:</p>

    <pre class="programlisting">
spamd -d -u spamassassin -x -a -P --virtual-config-dir=/var/lib/spamassassin/%u.prefs
</pre>

    <p>These meanings of these arguments are:</p>

    <dl>
      <dt><b>-d</b></dt>
      <dd>fork spamd on startup</dd>
      <dt><b>-u spamassassin</b></dt>
      <dd>run as the <tt>spamassassin</tt> user account.</dd>
      <dt><b>-x</b></dt>
      <dd>don't create <tt>user_prefs</tt> files for individual
      users</dd>
      <dt><b>-a</b></dt>
      <dd>create automatic whitelists, to smooth out the scores that
      individuals receive.</dd>
      <dt><b>-P</b></dt>
      <dd>paranoid mode</dd>
      <dt><b>--virtual-config-dir=/var/lib/spamassassin/%u.prefs</b></dt>
      <dd>create per-user configuration directories under the
      <tt>spamassassin</tt> user's home directory.  This way we can
      maintain separate automatic whitelists and Bayes databases for
      each mailing list.</dd>
    </dl>

    <p>If you are using the RPMs, you can put these options in a
    <tt>/etc/sysconfig/spamd</tt> file so that they will be passed to
    spamd when it is started:</p>

    <pre class="programlisting">
# Options to spamd
OPTIONS="-d -u spamassassin -x -a -P --virtual-config-dir=/var/lib/spamassassin/%u.prefs"

# don't bother with UTF-8 mode
export LANG=en_AU
</pre>

    <p>Next, you will want to set up your init scripts to start
    <tt>spamd</tt> when your system starts up.  If you are using the
    RPMs, this is trivial:</p>

    <pre class="programlisting">
chkconfig --level 345 spamassassin on
service spamassassin start
</pre>


    <h3>Adding the SpamAssassin Filter to Mailman</h3>

    <p>First you will need to download the filter, which is comprised
    of the following two files:</p>

    <ul>
      <li><a href="spamd.py">spamd.py</a> (updated 6-June-2003)</li>
      <li><a href="SpamAssassin.py">SpamAssassin.py</a> (updated 14-April-2003)</li>
    </ul>

    <p>Both files should be installed into the
    <tt>Mailman/Handlers/</tt> subdirectory under the Mailman install
    directory.  You will then need to edit the
    <tt>Mailman/mm_cfg.py</tt> file to enable the filter:</p>

    <pre class="programlisting">
GLOBAL_PIPELINE.insert(1, 'SpamAssassin')
</pre>

    <p>After making the changes to <tt>Mailman/mm_cfg.py</tt>, you
    will need to restart the <tt>qrunner</tt> process.  This can be
    achieved with the mailmanctl program:</p>

    <pre class="programlisting">
mailmanctl restart
</pre>

    <p>At this point, the SpamAssassin filter should operational.</p>


    <h2>Configuration</h2>

    <p>With the mailman filter in place, every incoming message will
    be passed off to SpamAssassin's <tt>spamd</tt> daemon for
    scoring.  The mailing list name will be sent as the user name.
    This allows us to maintain separate SpamAssassin data files for
    each list.</p>

    <p>After scoring, a message can be discarded if the score is over
    a certain threshold (defaulting to 10), or held for moderation if
    it the score is over another threshold (defaulting to 5).
    Additionally, a "bonus" can be subtracted from the scores of
    messages sent by list subscribers (defaulting to 2) to reduce the
    chance that subscriber posts are held or discarded.</p>

    <p>These settings can be tuned by editing the
    <tt>Mailman/mm_cfg.py</tt> file and adding the following
    variables:</p>

    <dl>
      <dt><b>SPAMASSASSIN_HOST</b></dt>
      <dd>The host spamd is running on.  A string in
      <em>hostname:port</em> format.</dd>
      <dt><b>SPAMASSASSIN_DISCARD_SCORE</b></dt>
      <dd>If a message receives a score above this limit, the message
      will be discarded without moderation.  The default value for
      this variable is 10.</dd>
      <dt><b>SPAMASSASSIN_HOLD_SCORE</b></dt>
      <dd>If a message receives a score above this limit, the message
      will be held for moderation.  The default value for this
      variable is 5.</dd>
      <dt><b>SPAMASSASSIN_MEMBER_BONUS</b></dt>
      <dd>If the message was sent by a member of the list, an
      adjustment can be performed on the score.  This makes it less
      likely that a message claiming to come from a list member will
      be held for moderation.  The default value for this variable is
      2.</dd>
    </dl>

    <p>As before, you will need to restart <tt>qrunner</tt> with
    <tt>mailmanctl</tt> after modifying the config file.</p>

    <p>For the <a
    href="http://www.daa.com.au/~james/software/pygtk/">PyGTK</a>
    mailing list, I use a discard score of 7.5 and a hold score of
    5.</p>


    <h2>Feeding the Bayes Database</h2>

    <p>By itself, SpamAssassin will filter the majority of spam
    directed at the lists.  For better results, you should look at
    seeding the Bayes database for your list.  This will customise the
    filter based on traffic to your list, which makes it more
    difficult for spammers to produce messages that get through.  In
    turn, the amount of administration required for the list will be
    reduced.</p>

    <p>To seed the Bayes database, you will need to feed it a corpus of
    spam and a corpus of "ham" (non-spam).  This is used to help it
    differentiate spam from normal list postings.  It is a good idea
    to use recent messages if possible, as they will better reflect
    the typical list traffic.</p>

    <p>If you run a closed list, your list archives should make a
    pretty good "ham" corpus.  Simply trim a few months off the bottom
    of the archive mbox (found in
    <tt>archives/private/<i>listname</i>.mbox</tt>), and pass them to
    <tt>sa-learn</tt>:</p>

    <pre class="programlisting">
HOME=/var/lib/spamassassin/<i>listname</i>.prefs \
    sa-learn --showdots --ham --mbox filename.mbox
</pre>

    <p>If you don't have a collection of recent spam messages, an
    other option is to train the database on messages that get held in
    the moderation queue.  To help with this, I wrote a small script
    called <a href="mmlearn"><tt>mmlearn</tt></a>.  After removing all
    legitimate messages from the moderation queue, you can run it on
    the remaining spam:</p>

    <pre class="programlisting">
mmlearn <i>listname</i>
</pre>

    <p>Training the filter based on false negatives is a fairly
    effective way of improving the filter.</p>


    <h2>The Future</h2>

    <p>In the future, it would be nice to add support for passing
    messages to the Bayes database directly from the moderation web
    page.  I am not sure how hard it would be to implement this.</p>
  </body>
</html>
